name: ğŸ‘€ Check for new n8n stable releases

on:
  schedule:
    - cron: '0 8 * * *' # Every day at 8am
  workflow_dispatch:

jobs:
  check-new-release:
    runs-on: ubuntu-latest

    timeout-minutes: 5

    permissions:
      contents: write

    outputs:
      n8n_version_to_release: ${{ steps.n8n_version.outputs.version_to_release }}

    steps:
      - name: ğŸ‘€ Get the latest custom image stable release
        id: custom_image_release
        uses: pozetroninc/github-action-get-latest-release@v0.7.0
        with:
          repository: CodelyTV/n8n-codely-custom-image
          excludes: prerelease,draft
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ†• Get the latest n8n stable release
        id: n8n_release
        uses: pozetroninc/github-action-get-latest-release@v0.7.0
        with:
          repository: n8n-io/n8n
          excludes: prerelease,draft
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¤² Compare n8n release versions
        id: compare_releases
        run: |
          echo "ğŸ‘€ Latest Codely custom image release: ${{ steps.custom_image_release.outputs.release }}"
          echo "ğŸ†• Latest n8n release: ${{ steps.n8n_release.outputs.release }}"

          if [ "${{ steps.custom_image_release.outputs.release }}" != "${{ steps.n8n_release.outputs.release }}" ]; then
            echo "release_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ¤© New release detected! Releasing new custom image version in 1, 2â€¦"
          else
            echo "release_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ‘ Release has not changed. Doing nothing."
          fi

      - name: ğŸ”¡ Remove 'n8n@' from release name to get the version
        id: n8n_version
        if: steps.compare_releases.outputs.release_changed == 'true'
        run: |
          version_to_release=$(echo "${{ steps.n8n_release.outputs.release }}" | sed 's/n8n@//g')
          echo "version_to_release=$version_to_release" >> $GITHUB_OUTPUT

  build-and-push-new-docker-image:
    needs: check-new-release
    uses: ./.github/workflows/build-and-push.yml
    with:
      n8n_version: ${{ needs.check-new-release.outputs.n8n_version_to_release }}
    secrets: inherit

  create-release:
    needs: [check-new-release, build-and-push-new-docker-image]
    runs-on: ubuntu-latest

    timeout-minutes: 1

    permissions:
      contents: write

    steps:
      - name: ğŸ·ï¸ Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          commit: main
          tag: ${{ needs.check-new-release.outputs.n8n_version_to_release }}
